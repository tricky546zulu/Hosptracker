{% extends "base.html" %}

{% block title %}PDF Debug - Hospital Capacity Monitor{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Debug Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-3">PDF Content Debugger</h1>
            <p class="text-muted">Inspect and adjust how hospital data is extracted from eHealth Saskatchewan PDFs</p>
        </div>
    </div>

    <!-- PDF Analysis Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">PDF Source</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">PDF URL</label>
                        <input type="url" class="form-control" id="pdf-url" 
                               value="https://www.ehealthsask.ca/reporting/Documents/SaskatoonHospitalBedCapacity.pdf">
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" onclick="analyzePDF()">
                            <i class="fas fa-search"></i> Analyze PDF Content
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Search Parameters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Section Keywords</label>
                        <input type="text" class="form-control" id="section-keywords" 
                               value="Emergency Department,Emergency,Total,RUH,SPH,SCH,JPCH">
                        <div class="form-text">Comma-separated keywords to find the data section</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hospital Codes</label>
                        <input type="text" class="form-control" id="hospital-codes" 
                               value="RUH,SPH,SCH,JPCH">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">PDF Content Analysis</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadRawText()">
                            <i class="fas fa-download"></i> Download Raw Text
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="testExtraction()">
                            <i class="fas fa-play"></i> Test Extraction
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="analysis-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing PDF content...</p>
                    </div>
                    
                    <div id="analysis-results" style="display: none;">
                        <!-- Tabs for different views -->
                        <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="raw-text-tab" data-bs-toggle="tab" data-bs-target="#raw-text" type="button" role="tab">
                                    Raw Text
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="filtered-lines-tab" data-bs-toggle="tab" data-bs-target="#filtered-lines" type="button" role="tab">
                                    Filtered Lines
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="extraction-test-tab" data-bs-toggle="tab" data-bs-target="#extraction-test" type="button" role="tab">
                                    Extraction Test
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content mt-3" id="analysisTabContent">
                            <!-- Raw Text Tab -->
                            <div class="tab-pane fade show active" id="raw-text" role="tabpanel">
                                <div class="mb-3">
                                    <label class="form-label">Full PDF Text Content</label>
                                    <textarea class="form-control" id="raw-text-content" rows="20" readonly></textarea>
                                </div>
                            </div>

                            <!-- Filtered Lines Tab -->
                            <div class="tab-pane fade" id="filtered-lines" role="tabpanel">
                                <div class="mb-3">
                                    <label class="form-label">Lines Containing Keywords</label>
                                    <div id="filtered-lines-content" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Filtered content will be inserted here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Extraction Test Tab -->
                            <div class="tab-pane fade" id="extraction-test" role="tabpanel">
                                <div class="mb-3">
                                    <label class="form-label">Extraction Results</label>
                                    <div id="extraction-results" class="border rounded p-3">
                                        <!-- Extraction results will be inserted here -->
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Extraction Configuration</label>
                                    <textarea class="form-control" id="extraction-config" rows="10" placeholder="Configure custom extraction rules..."></textarea>
                                    <div class="form-text">Adjust extraction parameters and test new configurations</div>
                                </div>
                                <button class="btn btn-success" onclick="applyCustomExtraction()">
                                    <i class="fas fa-save"></i> Apply Custom Extraction
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPdfData = null;

async function analyzePDF() {
    const pdfUrl = document.getElementById('pdf-url').value;
    
    // Show loading
    document.getElementById('analysis-loading').style.display = 'block';
    document.getElementById('analysis-results').style.display = 'none';
    
    try {
        const response = await fetch('/api/debug/analyze-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pdf_url: pdfUrl,
                keywords: document.getElementById('section-keywords').value,
                hospital_codes: document.getElementById('hospital-codes').value
            })
        });
        
        const data = await response.json();
        currentPdfData = data;
        
        if (data.error) {
            alert('Error analyzing PDF: ' + data.error);
            return;
        }
        
        displayAnalysisResults(data);
        
    } catch (error) {
        alert('Error analyzing PDF: ' + error.message);
    } finally {
        document.getElementById('analysis-loading').style.display = 'none';
    }
}

function displayAnalysisResults(data) {
    // Show results section
    document.getElementById('analysis-results').style.display = 'block';
    
    // Display raw text
    document.getElementById('raw-text-content').value = data.raw_text || 'No text extracted';
    
    // Display filtered lines
    const filteredContainer = document.getElementById('filtered-lines-content');
    filteredContainer.innerHTML = '';
    
    if (data.filtered_lines && data.filtered_lines.length > 0) {
        data.filtered_lines.forEach((line, index) => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'mb-2 p-2 border-bottom';
            lineDiv.innerHTML = `
                <strong>Line ${index + 1}:</strong><br>
                <code>${escapeHtml(line)}</code>
            `;
            filteredContainer.appendChild(lineDiv);
        });
    } else {
        filteredContainer.innerHTML = '<p class="text-muted">No lines found containing the specified keywords</p>';
    }
    
    // Display extraction results
    displayExtractionResults(data.extraction_results || []);
}

function displayExtractionResults(results) {
    const resultsContainer = document.getElementById('extraction-results');
    resultsContainer.innerHTML = '';
    
    if (results.length > 0) {
        results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-3 p-3 border rounded';
            resultDiv.innerHTML = `
                <h6>${result.hospital_name} (${result.hospital_code})</h6>
                <p><strong>Patient Count:</strong> ${result.total_patients || 'Not found'}</p>
                <p><strong>Source Line:</strong> <code>${escapeHtml(result.source_line || 'N/A')}</code></p>
                <p><strong>Numbers Found:</strong> ${JSON.stringify(result.numbers_found || [])}</p>
                ${result.validation_notes ? `<p><strong>Validation:</strong> ${result.validation_notes}</p>` : ''}
            `;
            resultsContainer.appendChild(resultDiv);
        });
    } else {
        resultsContainer.innerHTML = '<p class="text-warning">No hospital data extracted. The PDF format may have changed.</p>';
    }
}

async function testExtraction() {
    if (!currentPdfData) {
        alert('Please analyze the PDF first');
        return;
    }
    
    try {
        const response = await fetch('/api/debug/test-extraction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                raw_text: currentPdfData.raw_text,
                keywords: document.getElementById('section-keywords').value,
                hospital_codes: document.getElementById('hospital-codes').value
            })
        });
        
        const data = await response.json();
        displayExtractionResults(data.extraction_results || []);
        
    } catch (error) {
        alert('Error testing extraction: ' + error.message);
    }
}

function downloadRawText() {
    if (!currentPdfData || !currentPdfData.raw_text) {
        alert('No PDF text available. Please analyze a PDF first.');
        return;
    }
    
    const blob = new Blob([currentPdfData.raw_text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pdf_raw_text.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

async function applyCustomExtraction() {
    const config = document.getElementById('extraction-config').value;
    if (!config.trim()) {
        alert('Please enter extraction configuration');
        return;
    }
    
    try {
        const response = await fetch('/api/debug/apply-custom-extraction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                config: config,
                raw_text: currentPdfData?.raw_text
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Custom extraction configuration applied successfully');
            // Refresh the analysis
            analyzePDF();
        } else {
            alert('Error applying configuration: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        alert('Error applying custom extraction: ' + error.message);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Auto-analyze on load if URL is provided
    if (document.getElementById('pdf-url').value) {
        // Add a small delay to ensure page is fully loaded
        setTimeout(analyzePDF, 1000);
    }
});
</script>
{% endblock %}